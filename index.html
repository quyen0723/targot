<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·∫øt N√†y Ai ƒê·ªô?</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (via CDN for speed) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- CUSTOM THEME & ANIMATIONS --- */
        :root {
            --tet-red: #D72638;
            --tet-gold: #FFD700;
            --tet-dark: #1a0a1a;
            --paper-color: #FFFDF0;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--tet-dark);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(215, 38, 56, 0.15) 0%, transparent 30%),
                radial-gradient(circle at 90% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 30%);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .handwriting {
            font-family: 'Dancing Script', cursive;
        }

        .mystic-font {
            font-family: 'Playfair Display', serif;
        }

        /* --- CARD SPREAD CONTAINER --- */
        .card-spread-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: auto;
            overflow-y: visible;
            padding: 30px 10px 40px;
            -webkit-overflow-scrolling: touch;
        }

        .card-spread {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }

        .card-row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 15px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .card-rows-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: max-content;
        }

        /* --- SPREAD CARD STYLES --- */
        .spread-card {
            width: 70px;
            height: 122px;
            flex-shrink: 0;
            perspective: 1000px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: -30px;
            position: relative;
        }

        .spread-card.row-start {
            margin-left: 0;
        }

        .spread-card:hover {
            transform: translateY(-20px) scale(1.15);
            z-index: 100;
        }

        .spread-card.selected {
            transform: translateY(-25px) scale(1.2);
            z-index: 101;
        }

        .spread-card.disabled {
            pointer-events: none;
            opacity: 0.4;
            filter: grayscale(50%);
        }

        .spread-card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .spread-card.flipped .spread-card-inner {
            transform: rotateY(180deg);
        }

        .spread-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
        }

        .spread-card-back {
            background-color: #2a1a2a;
            border: 2px solid var(--tet-gold);
        }

        .spread-card-back img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spread-card-front {
            transform: rotateY(180deg);
            background-color: white;
        }

        .spread-card-front img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spread-card.selected .spread-card-inner {
            box-shadow: 0 0 30px 10px rgba(255, 215, 0, 0.7);
        }

        /* Selection indicator */
        .selection-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--tet-dark);
            font-size: 14px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* --- SHUFFLE ANIMATION --- */
        @keyframes shuffleCard {
            0% { transform: translateX(0) translateY(0) rotate(0deg); }
            25% { transform: translateX(100px) translateY(-50px) rotate(15deg); }
            50% { transform: translateX(-100px) translateY(50px) rotate(-15deg); }
            75% { transform: translateX(50px) translateY(-25px) rotate(10deg); }
            100% { transform: translateX(0) translateY(0) rotate(0deg); }
        }

        .shuffling .card-row .spread-card {
            animation: shuffleCard 0.6s ease-in-out;
        }

        .shuffling .card-row .spread-card:nth-child(odd) {
            animation-delay: 0.05s;
        }

        .shuffling .card-row .spread-card:nth-child(3n) {
            animation-delay: 0.1s;
        }

        /* --- UTILS --- */
        .btn-gold {
            background: linear-gradient(90deg, #FFD700, #FDB931);
            color: #3F0D12;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            transition: all 0.3s;
        }

        .btn-gold:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .btn-gold:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .hidden-screen {
            display: none;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--tet-gold);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Result card styles */
        .result-card-img {
            width: 100px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .result-card-img:hover {
            transform: scale(1.1);
        }

        /* Prose styles for markdown */
        .prose-result {
            line-height: 1.8;
        }

        .prose-result h1, .prose-result h2, .prose-result h3 {
            color: #FFD700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .prose-result p {
            margin-bottom: 0.75rem;
        }

        .prose-result strong {
            color: #FFD700;
        }

        .prose-result ul, .prose-result ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .prose-result li {
            margin-bottom: 0.25rem;
        }


        /* Mobile responsive */
        @media (max-width: 768px) {
            .card-spread-container {
                padding: 20px 0 30px;
                margin-left: 0;
                margin-right: 0;
            }

            .card-rows-container {
                padding-left: 15px;
            }

            .card-row {
                padding-left: 10px;
                padding-right: 30px;
            }

            .spread-card {
                width: 50px;
                height: 87px;
                margin-left: -22px;
            }

            .spread-card:hover,
            .spread-card.selected {
                transform: translateY(-15px) scale(1.15);
            }

            .result-card-img {
                width: 80px;
            }

            .card-spread {
                gap: 6px 0;
            }

            /* Hint ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt c√≥ th·ªÉ k√©o */
            .card-spread-container::after {
                content: '‚Üê K√©o ƒë·ªÉ xem th√™m ‚Üí';
                display: block;
                text-align: center;
                color: rgba(255, 215, 0, 0.6);
                font-size: 12px;
                margin-top: 10px;
                animation: pulse 2s infinite;
            }
        }

        @media (max-width: 480px) {
            .spread-card {
                width: 45px;
                height: 78px;
                margin-left: -20px;
            }

            .spread-card:hover,
            .spread-card.selected {
                transform: translateY(-12px) scale(1.2);
            }

            .selection-badge {
                width: 20px;
                height: 20px;
                font-size: 10px;
                top: -6px;
                right: -6px;
            }

            .result-card-img {
                width: 70px;
            }

            .card-spread {
                gap: 4px 0;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

    </style>
</head>
<body class="antialiased selection:bg-yellow-500 selection:text-red-900">

    <!-- DECORATION: Falling Petals -->
    <div class="fixed inset-0 pointer-events-none z-0 opacity-20" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Ccircle cx=\'2\' cy=\'2\' r=\'1\' fill=\'%23ffd700\'/%3E%3C/svg%3E');"></div>

    <div class="container mx-auto px-4 py-8 relative z-10 min-h-screen flex flex-col items-center">

        <!-- HEADER -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-6xl mystic-font text-yellow-400 drop-shadow-lg mb-2">T·∫øt N√†y Ai ƒê·ªô?</h1>
            <p class="text-white/80 text-sm md:text-lg italic">Qu√° Kh·ª© - Hi·ªán T·∫°i - T∆∞∆°ng Lai</p>
        </header>

        <!-- SCREEN 1: INPUT FORM -->
        <div id="screen-input" class="w-full max-w-md bg-white/10 backdrop-blur-md p-8 rounded-2xl border border-white/20 shadow-2xl">
            <div class="mb-4">
                <label class="block text-yellow-300 text-sm font-bold mb-2" for="username">T√™n c·ªßa b·∫°n</label>
                <input class="w-full px-4 py-3 rounded-lg bg-black/30 border border-yellow-600/50 text-white focus:outline-none focus:border-yellow-400 transition" id="username" type="text" placeholder="V√≠ d·ª•: Lan">
            </div>

            <div class="mb-4">
                <label class="block text-yellow-300 text-sm font-bold mb-2">B·∫°n mu·ªën h·ªèi v·ªÅ?</label>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <button onclick="selectTopic('T√¨nh Y√™u')" class="topic-btn border border-white/30 rounded-lg p-2 text-sm hover:bg-white/20 transition focus:ring-2 ring-yellow-400">T√¨nh Y√™u</button>
                    <button onclick="selectTopic('S·ª± Nghi·ªáp')" class="topic-btn border border-white/30 rounded-lg p-2 text-sm hover:bg-white/20 transition focus:ring-2 ring-yellow-400">S·ª± Nghi·ªáp</button>
                    <button onclick="selectTopic('Ti·ªÅn B·∫°c')" class="topic-btn border border-white/30 rounded-lg p-2 text-sm hover:bg-white/20 transition focus:ring-2 ring-yellow-400">Ti·ªÅn B·∫°c</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectTopic('S·ª©c Kh·ªèe')" class="topic-btn border border-white/30 rounded-lg p-2 text-sm hover:bg-white/20 transition focus:ring-2 ring-yellow-400">S·ª©c Kh·ªèe</button>
                    <button onclick="selectTopic('Gia ƒê√¨nh')" class="topic-btn border border-white/30 rounded-lg p-2 text-sm hover:bg-white/20 transition focus:ring-2 ring-yellow-400">Gia ƒê√¨nh</button>
                </div>
            </div>

            <div class="mb-8">
                <label class="block text-yellow-300 text-sm font-bold mb-2" for="userQuestion">C√¢u h·ªèi c·ª• th·ªÉ (N·∫øu c√≥)</label>
                <textarea class="w-full px-4 py-3 rounded-lg bg-black/30 border border-yellow-600/50 text-white focus:outline-none focus:border-yellow-400 transition resize-none" id="userQuestion" rows="2" placeholder="VD: NƒÉm nay c√≥ ng∆∞·ªùi y√™u kh√¥ng?"></textarea>
            </div>

            <button onclick="startJourney()" class="w-full btn-gold py-3 rounded-xl text-lg tracking-wider">B·∫Øt ƒê·∫ßu Gieo Qu·∫ª</button>
        </div>

        <!-- SCREEN 2: SELECT CARDS -->
        <div id="screen-select" class="hidden-screen w-full text-center">
            <h2 class="text-2xl text-white mb-2 handwriting">H√£y tƒ©nh t√¢m v√† ch·ªçn 3 l√° b√†i...</h2>
            <p class="text-yellow-300 mb-4">Qu√° Kh·ª© - Hi·ªán T·∫°i - T∆∞∆°ng Lai</p>

            <!-- Controls -->
            <div class="flex justify-center items-center gap-4 mb-4 flex-wrap">
                <button id="shuffle-btn" onclick="shuffleDeck()" class="btn-gold px-6 py-2 rounded-lg flex items-center gap-2">
                    <span>X√†o B√†i</span>
                </button>
                <div class="bg-white/10 px-4 py-2 rounded-lg">
                    <span class="text-white">ƒê√£ ch·ªçn: </span>
                    <span id="selected-count" class="text-yellow-400 font-bold">0</span>
                    <span class="text-white">/3</span>
                </div>
            </div>

            <!-- Card Spread Container -->
            <div class="card-spread-container" id="card-spread-container">
                <div class="card-rows-container" id="card-spread">
                    <!-- Cards will be generated by JS in 2 rows -->
                </div>
            </div>

            <!-- View Result Button -->
            <button id="view-result-btn" onclick="showResult()"
                class="hidden btn-gold mt-4 px-8 py-3 rounded-xl text-lg">
                Xem Th√¥ng ƒêi·ªáp V≈© Tr·ª•
            </button>
        </div>

        <!-- SCREEN 3: RESULT -->
        <div id="screen-result" class="hidden-screen w-full max-w-4xl">
            <!-- Loading State -->
            <div id="result-loading" class="text-center py-12">
                <div class="loader mb-6"></div>
                <p class="text-yellow-300 animate-pulse text-xl" id="loading-text">ƒêang k·∫øt n·ªëi v·ªõi v≈© tr·ª•...</p>
            </div>

            <!-- Result Content -->
            <div id="result-content" class="hidden">
                <!-- 3 Cards Display -->
                <div class="flex justify-center gap-4 md:gap-8 mb-8 flex-wrap">
                    <div class="text-center">
                        <p class="text-yellow-400 text-sm mb-2 font-bold">QU√Å KH·ª®</p>
                        <img id="card-1-img" class="result-card-img" src="" alt="">
                        <p id="card-1-name" class="text-white text-xs mt-2"></p>
                    </div>
                    <div class="text-center">
                        <p class="text-yellow-400 text-sm mb-2 font-bold">HI·ªÜN T·∫†I</p>
                        <img id="card-2-img" class="result-card-img" src="" alt="">
                        <p id="card-2-name" class="text-white text-xs mt-2"></p>
                    </div>
                    <div class="text-center">
                        <p class="text-yellow-400 text-sm mb-2 font-bold">T∆Ø∆†NG LAI</p>
                        <img id="card-3-img" class="result-card-img" src="" alt="">
                        <p id="card-3-name" class="text-white text-xs mt-2"></p>
                    </div>
                </div>

                <!-- Reading Content -->
                <div class="bg-white/10 backdrop-blur-md p-6 md:p-8 rounded-2xl border border-white/20">
                    <h3 class="text-2xl text-yellow-400 mystic-font mb-4 text-center">Th√¥ng ƒêi·ªáp T·ª´ V≈© Tr·ª•</h3>
                    <div id="reading-text" class="text-white prose-result">
                        <!-- Gemini response will be inserted here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center gap-4 mt-8">
                    <button onclick="resetApp()" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-full border border-white/30 transition">
                        B√≥i L·∫°i
                    </button>
                    <button onclick="shareResult()" class="btn-gold px-6 py-3 rounded-full">
                        Chia S·∫ª
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const TAROT_API_URL = 'https://tarot-api.quyennnm-work.workers.dev/';
        const CARDS_TO_SELECT = 3;

        // --- STATE ---
        let tarotData = [];
        let shuffledDeck = [];
        let selectedCards = [];
        let isShuffling = false;
        let userData = {
            name: '',
            topic: '',
            question: ''
        };

        const loadingTexts = [
            "ƒêang k·∫øt n·ªëi v·ªõi v≈© tr·ª•...",
            "ƒêang tri·ªáu h·ªìi c√°c v·ªã th·∫ßn...",
            "ƒêang xin v√≠a Th·∫ßn T√†i...",
            "Tarot Reader ƒëang l·∫≠t s√°ch...",
            "T√≠n hi·ªáu t√¢m linh h∆°i y·∫øu, ch·ªù x√≠u..."
        ];

        // --- INIT ---
        async function initApp() {
            try {
                const response = await fetch('tarot-data.json');
                const data = await response.json();
                tarotData = data.cards;
                console.log('Loaded', tarotData.length, 'cards');
            } catch (error) {
                console.error('Error loading tarot data:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i Tarot. Vui l√≤ng th·ª≠ l·∫°i!');
            }
        }

        window.addEventListener('DOMContentLoaded', initApp);

        // --- TOPIC SELECTION ---
        function selectTopic(topic) {
            userData.topic = topic;
            document.querySelectorAll('.topic-btn').forEach(btn => {
                btn.classList.remove('bg-white/40', 'ring-2');
                if(btn.textContent.includes(topic)) {
                    btn.classList.add('bg-white/40', 'ring-2');
                }
            });
        }

        // --- START JOURNEY ---
        function startJourney() {
            const nameInput = document.getElementById('username').value.trim();
            const questionInput = document.getElementById('userQuestion').value.trim();

            if (!nameInput || !userData.topic) {
                alert("Vui l√≤ng nh·∫≠p t√™n v√† ch·ªçn ch·ªß ƒë·ªÅ!");
                return;
            }

            userData.name = nameInput;
            userData.question = questionInput;

            // Switch screens
            document.getElementById('screen-input').classList.add('hidden-screen');
            document.getElementById('screen-select').classList.remove('hidden-screen');

            // Shuffle and render
            shuffleDeck();
        }

        // --- SHUFFLE DECK ---
        function shuffleDeck() {
            if (isShuffling) return;

            // Reset state
            selectedCards = [];
            document.getElementById('selected-count').textContent = '0';
            document.getElementById('view-result-btn').classList.add('hidden');

            // Disable shuffle button during animation
            isShuffling = true;
            const shuffleBtn = document.getElementById('shuffle-btn');
            shuffleBtn.disabled = true;

            // Add shuffle animation class
            const spread = document.getElementById('card-spread');
            spread.classList.add('shuffling');

            // Fisher-Yates shuffle
            shuffledDeck = [...tarotData];
            for (let i = shuffledDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledDeck[i], shuffledDeck[j]] = [shuffledDeck[j], shuffledDeck[i]];
            }

            // Wait for animation then render
            setTimeout(() => {
                spread.classList.remove('shuffling');
                renderCards();
                isShuffling = false;
                shuffleBtn.disabled = false;
            }, 700);
        }

        // --- RENDER CARDS ---
        function renderCards() {
            const container = document.getElementById('card-spread');
            container.innerHTML = '';

            // Split 78 cards into 2 rows (39 each)
            const row1Cards = shuffledDeck.slice(0, 39);
            const row2Cards = shuffledDeck.slice(39, 78);

            // Create row 1
            const row1 = document.createElement('div');
            row1.className = 'card-row';
            row1Cards.forEach((card, index) => {
                const cardEl = createCardElement(card, index);
                row1.appendChild(cardEl);
            });
            container.appendChild(row1);

            // Create row 2
            const row2 = document.createElement('div');
            row2.className = 'card-row';
            row2Cards.forEach((card, index) => {
                const cardEl = createCardElement(card, index + 39);
                row2.appendChild(cardEl);
            });
            container.appendChild(row2);
        }

        function createCardElement(card, index) {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'spread-card';
            if (index === 0 || index === 39) {
                cardWrapper.classList.add('row-start');
            }
            cardWrapper.dataset.cardId = card.id;
            cardWrapper.dataset.index = index;

            cardWrapper.innerHTML = `
                <div class="spread-card-inner">
                    <div class="spread-card-face spread-card-back">
                        <img src="cards-png/matsaulabai.png" alt="Card Back">
                    </div>
                    <div class="spread-card-face spread-card-front">
                        <img src="${card.image}" alt="${card.name}">
                    </div>
                </div>
            `;

            cardWrapper.onclick = () => onCardSelect(cardWrapper, card, index);
            return cardWrapper;
        }

        // --- CARD SELECTION ---
        function onCardSelect(element, card, index) {
            // Prevent selection during shuffling
            if (isShuffling) return;

            // Check if already selected
            if (selectedCards.find(c => c.id === card.id)) {
                return;
            }

            // Check if max selected
            if (selectedCards.length >= CARDS_TO_SELECT) {
                return;
            }

            // Flip card and add selected class
            element.classList.add('flipped', 'selected');

            // Add selection badge
            const badge = document.createElement('div');
            badge.className = 'selection-badge';
            badge.textContent = selectedCards.length + 1;
            element.appendChild(badge);

            // Add to selected
            selectedCards.push(card);
            document.getElementById('selected-count').textContent = selectedCards.length;

            // Check if we have 3 cards
            if (selectedCards.length === CARDS_TO_SELECT) {
                // Disable all remaining cards
                document.querySelectorAll('.spread-card:not(.selected)').forEach(el => {
                    el.classList.add('disabled');
                });

                // Show result button after a short delay
                setTimeout(() => {
                    document.getElementById('view-result-btn').classList.remove('hidden');
                }, 500);
            }
        }

        // --- SHOW RESULT ---
        async function showResult() {
            // Switch to result screen
            document.getElementById('screen-select').classList.add('hidden-screen');
            document.getElementById('screen-result').classList.remove('hidden-screen');

            // Show loading
            document.getElementById('result-loading').classList.remove('hidden');
            document.getElementById('result-content').classList.add('hidden');

            // Animate loading text
            let textIdx = 0;
            const textInterval = setInterval(() => {
                document.getElementById('loading-text').textContent = loadingTexts[textIdx % loadingTexts.length];
                textIdx++;
            }, 1500);

            try {
                // Get reading from Gemini
                const reading = await getOpenAIReading();

                clearInterval(textInterval);

                // Display cards
                displaySelectedCards();

                // Display reading
                document.getElementById('reading-text').innerHTML = parseMarkdown(reading);

                // Show content
                document.getElementById('result-loading').classList.add('hidden');
                document.getElementById('result-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error getting reading:', error);
                clearInterval(textInterval);

                // Show fallback with error notice
                displaySelectedCards();
                const errorNotice = `
‚ö†Ô∏è **L∆∞u √Ω:** Kh√¥ng th·ªÉ k·∫øt n·ªëi Gemini API (${error.message}). ƒê√¢y l√† b√†i ƒë·ªçc offline.

---

`;
                document.getElementById('reading-text').innerHTML = parseMarkdown(errorNotice + generateFallbackReading());
                document.getElementById('result-loading').classList.add('hidden');
                document.getElementById('result-content').classList.remove('hidden');
            }
        }

        // --- DISPLAY SELECTED CARDS ---
        function displaySelectedCards() {
            for (let i = 0; i < 3; i++) {
                const card = selectedCards[i];
                document.getElementById(`card-${i+1}-img`).src = card.image;
                document.getElementById(`card-${i+1}-img`).alt = card.name;
                document.getElementById(`card-${i+1}-name`).textContent = card.nameVi;
            }
        }

        // --- TAROT API CALL (via Cloudflare Worker) ---
        async function getOpenAIReading() {
            const hasQuestion = userData.question && userData.question.trim().length > 0;

            // Prompt kh√°c nhau t√πy theo c√≥ c√¢u h·ªèi c·ª• th·ªÉ hay kh√¥ng
            let prompt;

            if (hasQuestion) {
                // Prompt khi C√ì c√¢u h·ªèi c·ª• th·ªÉ - ∆∞u ti√™n tr·∫£ l·ªùi c√¢u h·ªèi
                prompt = `B·∫°n l√† chuy√™n gia Tarot 20 nƒÉm kinh nghi·ªám. Nhi·ªám v·ª• QUAN TR·ªåNG NH·∫§T: TR·∫¢ L·ªúI TR·ª∞C TI·∫æP c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng.

üë§ NG∆Ø·ªúI H·ªéI: ${userData.name}
üìå CH·ª¶ ƒê·ªÄ: ${userData.topic}

üéØ C√ÇU H·ªéI C·∫¶N TR·∫¢ L·ªúI: "${userData.question}"

3 l√° b√†i ƒë√£ r√∫t (Qu√° Kh·ª© ‚Üí Hi·ªán T·∫°i ‚Üí T∆∞∆°ng Lai):
1. QU√Å KH·ª®: ${selectedCards[0].nameVi} - ${selectedCards[0].keywords.join(', ')}
2. HI·ªÜN T·∫†I: ${selectedCards[1].nameVi} - ${selectedCards[1].keywords.join(', ')}
3. T∆Ø∆†NG LAI: ${selectedCards[2].nameVi} - ${selectedCards[2].keywords.join(', ')}

√ù nghƒ©a c√°c l√°:
- ${selectedCards[0].nameVi}: ${selectedCards[0].meaning}
- ${selectedCards[1].nameVi}: ${selectedCards[1].meaning}
- ${selectedCards[2].nameVi}: ${selectedCards[2].meaning}

===== B·∫ÆT BU·ªòC VI·∫æT THEO FORMAT SAU =====

## üéØ Tr·∫£ L·ªùi: "${userData.question}"
(PH·∫¶N N√ÄY L√Ä QUAN TR·ªåNG NH·∫§T! Tr·∫£ l·ªùi C·ª§ TH·ªÇ, TR·ª∞C TI·∫æP c√¢u h·ªèi "${userData.question}" d·ª±a tr√™n 3 l√° b√†i. ƒê∆∞a ra c√¢u tr·∫£ l·ªùi r√µ r√†ng: C√≥/Kh√¥ng/C√≥ th·ªÉ, k√®m gi·∫£i th√≠ch ng·∫Øn g·ªçn t·ª´ c√°c l√° b√†i. V√≠ d·ª•: "C√≥ kh·∫£ nƒÉng cao!" ho·∫∑c "C·∫ßn ki√™n nh·∫´n th√™m..." Vi·∫øt 3-4 c√¢u t·∫≠p trung v√†o c√¢u h·ªèi.)

## C√¢u Chuy·ªán 3 L√°
(2-3 c√¢u k·∫øt n·ªëi 3 l√° th√†nh m·∫°ch truy·ªán li√™n quan ƒë·∫øn c√¢u h·ªèi)

## Ph√¢n T√≠ch Chi Ti·∫øt
### üîÆ Qu√° Kh·ª© - ${selectedCards[0].nameVi}
(Qu√° kh·ª© ·∫£nh h∆∞·ªüng th·∫ø n√†o ƒë·∫øn c√¢u h·ªèi)

### ‚ö° Hi·ªán T·∫°i - ${selectedCards[1].nameVi}
(T√¨nh h√¨nh hi·ªán t·∫°i li√™n quan ƒë·∫øn c√¢u h·ªèi)

### üåü T∆∞∆°ng Lai - ${selectedCards[2].nameVi}
(Tri·ªÉn v·ªçng t∆∞∆°ng lai cho c√¢u h·ªèi)

## L·ªùi Khuy√™n
(L·ªùi khuy√™n c·ª• th·ªÉ ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c ƒëi·ªÅu ${userData.name} mong mu·ªën)

Gi·ªçng vƒÉn: Th√¢n thi·ªán, vui v·∫ª, d√πng emoji. QUAN TR·ªåNG: Vi·∫øt ti·∫øng Vi·ªát C√ì D·∫§U. PH·∫¶N "Tr·∫£ L·ªùi" ph·∫£i ƒë·∫∑t L√äN ƒê·∫¶U v√† tr·∫£ l·ªùi TR·ª∞C TI·∫æP c√¢u h·ªèi!`;
            } else {
                // Prompt khi KH√îNG c√≥ c√¢u h·ªèi c·ª• th·ªÉ
                prompt = `B·∫°n l√† chuy√™n gia Tarot 20 nƒÉm kinh nghi·ªám, phong c√°ch vui v·∫ª th√¢n thi·ªán.

üë§ NG∆Ø·ªúI H·ªéI: ${userData.name}
üìå CH·ª¶ ƒê·ªÄ QUAN T√ÇM: ${userData.topic}

3 l√° b√†i ƒë√£ r√∫t (Qu√° Kh·ª© ‚Üí Hi·ªán T·∫°i ‚Üí T∆∞∆°ng Lai):
1. QU√Å KH·ª®: ${selectedCards[0].nameVi} - ${selectedCards[0].keywords.join(', ')}
2. HI·ªÜN T·∫†I: ${selectedCards[1].nameVi} - ${selectedCards[1].keywords.join(', ')}
3. T∆Ø∆†NG LAI: ${selectedCards[2].nameVi} - ${selectedCards[2].keywords.join(', ')}

√ù nghƒ©a c√°c l√°:
- ${selectedCards[0].nameVi}: ${selectedCards[0].meaning}
- ${selectedCards[1].nameVi}: ${selectedCards[1].meaning}
- ${selectedCards[2].nameVi}: ${selectedCards[2].meaning}

===== VI·∫æT THEO FORMAT SAU =====

## C√¢u Chuy·ªán 3 L√° B√†i
(2-3 c√¢u k·∫øt n·ªëi 3 l√° th√†nh m·∫°ch truy·ªán v·ªÅ ${userData.topic})

## Ph√¢n T√≠ch Chi Ti·∫øt

### üîÆ Qu√° Kh·ª© - ${selectedCards[0].nameVi}
(Qu√° kh·ª© ƒë√£ ·∫£nh h∆∞·ªüng th·∫ø n√†o ƒë·∫øn ${userData.topic})

### ‚ö° Hi·ªán T·∫°i - ${selectedCards[1].nameVi}
(Hi·ªán t·∫°i c·∫ßn ch√∫ √Ω g√¨ v·ªÅ ${userData.topic})

### üåü T∆∞∆°ng Lai - ${selectedCards[2].nameVi}
(T∆∞∆°ng lai ${userData.topic} s·∫Ω ra sao)

## L·ªùi Khuy√™n Cho ${userData.topic}
(L·ªùi khuy√™n c·ª• th·ªÉ v√† th·ª±c t·∫ø)

Gi·ªçng vƒÉn: Th√¢n thi·ªán, vui v·∫ª, d√πng emoji ph√π h·ª£p. QUAN TR·ªåNG: Vi·∫øt ti·∫øng Vi·ªát C√ì D·∫§U ƒë·∫ßy ƒë·ªß.`;
            }

            // G·ªçi Cloudflare Worker API thay v√¨ OpenAI tr·ª±c ti·∫øp
            const response = await fetch(TAROT_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.8,
                    max_tokens: 1500
                })
            });

            if (!response.ok) {
                const errorText = await response.text().catch(() => 'Unknown error');
                console.error('API Error Response:', response.status, errorText);
                throw new Error(`API request failed: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            console.log('Tarot API Response:', data);

            if (data.content) {
                return data.content;
            } else if (data.choices && data.choices[0] && data.choices[0].message) {
                return data.choices[0].message.content;
            } else {
                console.error('Invalid API response structure:', data);
                throw new Error('Invalid API response structure');
            }
        }

        // --- PARSE MARKDOWN ---
        function parseMarkdown(text) {
            // Try using marked library first
            if (typeof marked !== 'undefined' && marked.parse) {
                try {
                    return marked.parse(text);
                } catch (e) {
                    console.error('Marked parse error:', e);
                }
            }

            // Fallback: simple regex-based markdown parsing
            let html = text
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            return '<p>' + html + '</p>';
        }

        // --- FALLBACK READING ---
        function generateFallbackReading() {
            return `
## C√¢u Chuy·ªán 3 L√° B√†i

${userData.name} ∆°i, b·ªô 3 l√° b√†i c·ªßa b·∫°n r·∫•t th√∫ v·ªã! T·ª´ **${selectedCards[0].nameVi}** trong qu√° kh·ª©, ƒë·∫øn **${selectedCards[1].nameVi}** ·ªü hi·ªán t·∫°i, v√† h∆∞·ªõng t·ªõi **${selectedCards[2].nameVi}** trong t∆∞∆°ng lai - ƒë√¢y l√† m·ªôt h√†nh tr√¨nh ƒë·∫ßy √Ω nghƒ©a!

## Ph√¢n T√≠ch Chi Ti·∫øt

### üîÆ Qu√° Kh·ª© - ${selectedCards[0].nameVi}
${selectedCards[0].meaning}

**T·ª´ kh√≥a:** ${selectedCards[0].keywords.join(', ')}

### ‚ö° Hi·ªán T·∫°i - ${selectedCards[1].nameVi}
${selectedCards[1].meaning}

**T·ª´ kh√≥a:** ${selectedCards[1].keywords.join(', ')}

### üåü T∆∞∆°ng Lai - ${selectedCards[2].nameVi}
${selectedCards[2].meaning}

**T·ª´ kh√≥a:** ${selectedCards[2].keywords.join(', ')}

## L·ªùi Khuy√™n Cho ${userData.topic}

${selectedCards[0].advice} ${selectedCards[1].advice} ${selectedCards[2].advice}

*Ch√∫c ${userData.name} m·ªôt nƒÉm m·ªõi th·∫≠t nhi·ªÅu may m·∫Øn v√† h·∫°nh ph√∫c!*
            `;
        }

        // --- RESET APP ---
        function resetApp() {
            location.reload();
        }

        // --- SHARE RESULT ---
        function shareResult() {
            const text = `Toi vua boi Tarot 3 la!

Qua Khu: ${selectedCards[0].nameVi}
Hien Tai: ${selectedCards[1].nameVi}
Tuong Lai: ${selectedCards[2].nameVi}

Thu ngay tai: ${window.location.href}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Tarot 3 La - Ket Qua Boi',
                    text: text,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert("ƒê√£ copy n·ªôi dung! Gi·ªù d√°n l√™n Facebook th√¥i!");
                });
            }
        }

    </script>
</body>
</html>
